function indexService(e){function r(r){Stamplay.User.login(r).then(function(r){return e.user=r,$("#login-dialog").modal("hide"),o(r)},function(e){console.log(e)})}function o(e){if(e){var r={usuario:e},o=new Stamplay.Codeblock("consultarreservas");return o.run(r).then(function(e){return e},function(e){return console.error(e),null})}$("#login-dialog").modal()}function n(e){Stamplay.User.remove(e._id).then(function(r){Stamplay.Object("usuarioparqueo").remove({_id:e.perfil._id}).then(function(e){console.log(e)},function(e){console.log(e)})},function(e){console.log(e)})}var a={buscarPorDia:o,login:r,deleteUser:n};return a}function indexCtrl(e,r,o,n){var a=this;$.material.init(),$("#search").collapse("show"),e.credenciales={},a.reservas=[],a.usuariosparqueo=[],e.percentRes=65,e.percentDis=35,e.options={animate:{duration:1e3,enabled:!0},barColor:"RED",scaleColor:"#e8eff0",lineWidth:10,size:150,lineCap:"butt"},e.labels=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],e.series=["Reservas"],e.data=[],e.onClick=function(e,r){console.log(e,r)},e.datasetOverride=[{yAxisID:"y-axis-1"}],e.optionsLine={responsive:!0,scales:{yAxes:[{id:"y-axis-1",type:"linear",display:!0,position:"left"}]}},n.currentUser().then(function(e){e||r.user?(r.user=e?e:r.user,Stamplay.Object("usuarios").get({owner:r.user._id}).then(function(e){r.user.perfil=e.data[0],setRol(),"admin"==r.user.perfil.rol?a.buscarUsuariosParqueos():(a.buscarReservasDia(),a.estadisticasAnual())},function(e){console.log(e)})):(console.log("No hay usuario logueado"),$("#login-dialog").modal())}),a.login=function(){o.login(a.credenciales),setRol()},setRol=function(){Stamplay.User.getRoles().then(function(e){for(var o=e.data.length-1;o>=0;o--)e.data[o]._id==r.user.perfil.givenRole&&(r.user.perfil.rol=e.data[o].name)},function(e){console.error(e)})},a.buscarReservasDia=function(){o.buscarPorDia(r.user).then(function(r){console.log(r),a.reservas=r,e.$digest()})},a.estadisticasAnual=function(){var r=new Stamplay.Codeblock("reservasanual");r.run({}).then(function(r){e.data=[r]},function(e){console.error(e)})},a.buscarUsuariosParqueos=function(){var r=new Stamplay.Codeblock("usuariosparqueos");r.run({}).then(function(r){console.log(r),a.usuariosparqueo=r,e.$digest()},function(e){console.error(e)})},a.eliminarUsuario=function(r){o.deleteUser(r).then(function(r){a.buscarUsuariosParqueos(),e.$digest()})},a.estadia=function(e){var r=new Date(e);return r.getDate()+"/"+r.getMonth()+"/"+r.getFullYear()+" - "+r.getHours()+":"+(0==r.getMinutes()?"00":"30")},r.esRolAdmin=function(){return"admin"==r.user.perfil.rol},r.esRolParqueo=function(){return"parqueo"==r.user.perfil.rol},$(".hora").bootstrapMaterialDatePicker({format:"DD/MM/YYYY HH:mm",date:!1})}function navService(e){function r(e){var r=new Stamplay.Codeblock("consultadisponibilidadparqueo");return r.run(e).then(function(e){return e},function(e){return console.error(e),null})}function o(e){return Stamplay.Object("usuarioparqueo").get({usuario:e.id}).then(function(e){return e},function(e){console.log(e)})}function n(e){return Stamplay.Object("reservar").save(e).then(function(e){return e},function(e){console.log(e)})}function a(e){return Stamplay.Object("parqueos").get({_id:e}).then(function(e){return e},function(e){console.error(e)})}var t={buscarDisponibilidad:r,getParqueoUsuario:o,reservar:n,getParqueo:a};return t}function navCtrl(e,o,n){var a=this;$.material.init(),a.filter={},a.reserva={},a.validatePayphone=!1,a.validate=!1,a.montos=[],visibility=function(e){$("#hd").prop("disabled",e),$("#hh").prop("disabled",e),$("#tv").prop("disabled",e),$("#search").collapse(e?"hide":"show"),$("#searchPanel").collapse(e?"show":"hide")},a.showDisponibilidad=function(){a.filter={},a.reserva={},a.validatePayphone=!1,a.validate=!1,visibility(!1),$("#busqueda-dialog").modal()},a.buscarDisponibilidad=function(){n.getParqueoUsuario(o.user).then(function(r){a.filter.pId=r.data[0].parqueo;var o={hD:new Date(a.filter.hD),hH:new Date(a.filter.hH),tV:a.reserva.TipoVehiculo,pId:a.filter.pId};n.buscarDisponibilidad(o).then(function(r){r&&(console.log(r),a.reserva.puestoParqueo=r,visibility(!0),a.validate=!0,a.reserva.Monto=calcularMonto(),e.$digest())},function(e){console.error(e)})},function(e){console.error(e)})},calcularMonto=function(){n.getParqueo(a.filter.pId[0]).then(function(e){return a.reserva.Parqueo=e.data[0]._id,a.montos=[parseFloat(e.data[0].ValorXHoraL),parseFloat(e.data[0].ValorXHoraP),parseFloat(e.data[0].ValorXHoraM)],(r.formatHora(a.filter.hH)-r.formatHora(a.filter.hD))*a.montos[a.reserva.TipoVehiculo]},function(e){console.log(e)})},o.formatHora=function(e){return e=e.split(":"),parseFloat(e[0]+"."+e[1].replace("3","5"))},a.cambiarModoPago=function(){"0"==a.filter.tP?($("#pagoPanel").collapse("hide"),a.validatePayphone=!1):($("#pagoPanel").collapse("show"),a.validatePayphone=!0)},a.reservar=function(){a.reserva.HoraDesde=new Date(a.filter.hD),a.reserva.HoraHasta=new Date(a.filter.hH),a.reserva.Estado="P",a.reserva.Usuario=o.user.id,n.reservar(a.reserva).then(function(e){e&&addAlert()},function(e){console.error(e)})},a.cancelarReserva=function(e){}}angular.module("MiParking",["ui.router","chart.js","easypiechart"]).factory("AccountService",["$q",function(e){return{currentUser:function(){var r=e.defer();return Stamplay.User.currentUser().then(function(e){void 0===e.user?r.resolve(!1):r.resolve(e.user)},function(e){r.reject()}),r.promise}}}]).config(["$stateProvider","$urlRouterProvider",function(e,r){r.otherwise("/"),e.state("home",{url:"/",sticky:!0,dsr:!0,views:{navView:{templateUrl:"templates/nav.html",controller:"navCtrl as ctrl"},contentView:{templateUrl:"templates/index.html",controller:"indexCtrl as ctrl"}}})}]),angular.module("MiParking").factory("indexService",["$rootScope",indexService]),angular.module("MiParking").controller("indexCtrl",["$scope","$rootScope","indexService","AccountService",indexCtrl]),angular.module("MiParking").factory("navService",["$rootScope",navService]),angular.module("MiParking").controller("navCtrl",["$scope","$rootScope","navService","AccountService",navCtrl]);
//# sourceMappingURL=maps/app.js.map
